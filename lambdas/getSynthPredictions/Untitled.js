//Import AWS
let AWS = require("aws-sdk");

//Data that we are going to send to endpoint
//REPLACE THIS WITH YOUR OWN DATA!
let endpointData = {
  instances: [
    {
      start: "2020-04-02 04:00:00",
      target: [
        103.14545791020413, 99.2405220056222, 115.00108695619997,
        118.70951665843542, 119.35811230951796, 122.00482062116828,
        116.32315821030562, 119.92826662761375, 114.58136228870467,
        120.6398897024132, 111.91483351170413, 106.1987665225136,
        101.47424439862243, 100.93252598155742, 97.85473537858684,
        87.93243464081388, 89.24626026324876, 85.32415087428106,
        91.52944265305743, 89.14943696540675, 89.14702892204177,
        94.40385293867503, 102.73955044731204, 105.28480891583641,
        109.28110564291703, 121.43930880103191, 124.98970203488234,
        123.41008906895777, 124.48190781854538, 134.63076931938076,
        133.41057115409635, 131.97286457971262, 125.23653267056208,
        127.10045213079555, 129.95169931919997, 120.42088473543032,
        119.76177562977566, 110.68578099854219, 110.52658197503207,
        102.82290576471975, 100.9384815445415, 94.93331782033766,
        97.64510357023485, 104.5960954880389, 99.35290334087209,
        107.05383675437639, 108.27046428020633, 117.4006149417971,
        125.08045629131217, 122.6853817842808, 133.33862613014128,
        135.4978934706682, 145.99847235484503, 149.42966610153258,
        145.57423167110858, 144.9793267382208, 143.570771352635,
        135.45644972251264, 138.50529880965067, 138.16256639298635,
        125.16934632454634, 120.35649914346621, 116.3020176843173,
        120.36512586064435, 109.95108478701559, 108.00426663027366,
        114.2212826570468, 111.52729444841005, 117.00609957811805,
        119.995729762309, 124.7131706622362, 131.75548526169842,
        129.52454913099504, 138.91107553426647, 140.97684491389862,
        151.96889141006727, 148.95575908700485, 160.94089347740316,
        163.38729986188392, 156.6185836288999, 156.20883969092384,
        158.0941298623106, 143.1310331308817, 144.38642826271956,
        133.59286605712722, 140.56918705247384, 135.700113017212,
        128.98818529839934, 124.89621252389749, 124.65290177644542,
        117.46539052226179, 125.82758124305846, 129.50927718113874,
        129.81314491970352, 129.2901666594651, 147.4246575000084,
        142.62659469561515, 146.56136098248106, 160.1688203131941,
        162.75315856613767, 165.87927394206304, 160.3805383016797,
        175.94279734291916, 168.09389770245505, 159.36052308592426,
        156.6892098033514, 160.9101410507526, 154.98350696700842,
        150.8534678469576, 148.34241152208196, 142.63983722278215,
        137.62165802129488, 138.20338631616465, 141.52920038222575,
        137.53358746045956, 132.85780366472991, 138.6009379037402,
        141.21927268231957, 150.6066246463495, 148.82590026321787,
        152.39877453381462, 169.9820176629017, 160.4294199361072,
        177.1206806903754, 180.41522073791623, 176.04097876601443,
        176.53366199797324, 184.13330760760735, 172.5774358062313,
        178.52931259404934, 171.576337675425, 161.90559527995075,
        162.58717571541789, 162.88031696399952, 154.18655492392938,
        149.40559860995816, 147.64704897427563, 143.014729775577,
        141.26902556601866, 149.94678693241178, 153.64423518257436,
        147.4654881441062, 153.54436700311183, 156.30127407662224,
        174.3667118479654, 182.1339236803209, 175.97013121464937,
        183.68597447398255, 195.07114695674215, 183.7834397856875,
      ],
    },
  ],
  configuration: {
    num_samples: 50,
    output_types: ["mean", "quantiles", "samples"],
    quantiles: ["0.1", "0.9"],
  },
};

//Name of endpoint
//REPLACE THIS WITH THE NAME OF YOUR ENDPOINT
const endpointName = "synth-1-endpoint";

//Parameters for calling endpoint
let params = {
  EndpointName: endpointName,
  Body: JSON.stringify(endpointData),
  ContentType: "application/json",
  Accept: "application/json",
};

//AWS class that will query endpoint
let awsRuntime = new AWS.SageMakerRuntime({});

//Handler for Lambda function
exports.handler = (event) => {
  //Call endpoint and handle response
  awsRuntime.invokeEndpoint(params, (err, data) => {
    if (err) {
      //An error occurred
      console.log(err, err.stack);

      //Return error response
      const response = {
        statusCode: 500,
        body: JSON.stringify("ERROR: " + JSON.stringify(err)),
      };
      return response;
    } else {
      //Successful response
      //Convert response data to JSON
      let responseData = JSON.parse(Buffer.from(data.Body).toString("utf8"));
      console.log(JSON.stringify(responseData));

      //TODO: STORE DATA IN PREDICTION TABLE

      //Return successful response
      const response = {
        statusCode: 200,
        body: JSON.stringify("Predictions stored."),
      };
      return response;
    }
  });
};
